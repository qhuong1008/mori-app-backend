image: docker:20.10.14

services:
  - docker:20.10.14-dind

variables:
  DOCKER_IMAGE: "qhuong1008/mori-backend"
  DOCKER_USER: "qhuong1008"
  DOCKER_PASSWORD: "Huong560045@"
  REMOTE_SERVER: "hcmute@103.130.211.150"
  REMOTE_PORT: 10038
  SSH_SERVER_IP: "103.130.211.150"
  MORI_SSH_PRIVATE_KEY: $MORI_SSH_PRIVATE_KEY
  ID_RSA: "~/.ssh/id_rsa"

stages:
  - access-remote-server
  - deploy
  - build

access-remote-server:
  stage: access-remote-server
  before_script:
    - apk update && apk add openssh-client bash
  script:
    - eval $(ssh-agent -s)

    # thêm nội dung của biến SSH_PRIVATE_KEY vào agent store
    - bash -c 'ssh-add <(echo "$MORI_SSH_PRIVATE_KEY")'
    
    # tạo folder ~/.ssh
    - mkdir -p ~/.ssh
    
    # Scan lấy SSH Host key cho địa chỉ IP server
    # Được kết quả bao nhiêu thì thêm vào file known_hosts
    - ssh-keyscan -H $SSH_SERVER_IP:10038 >> ~/.ssh/known_hosts
    
    # Sửa lại quyền của file known_hosts
    - chmod 644 ~/.ssh/known_hosts
    
    # Thực hiện SSH vào server, login vào Registry, chuyển tới folder project
    # Down project, pull image về, up project và xoá đi image cũ
    - ssh hcmute@103.130.211.150 -p 10038

build:
  stage: build
  script:
    - docker login -u "$DOCKER_USER" -p "$DOCKER_PASSWORD"
    - npm i
    - docker build -t backend .
    - docker tag backend "$DOCKER_IMAGE"
    - docker push "$DOCKER_IMAGE"



  only:
    - main
